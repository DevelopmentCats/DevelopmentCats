name: Update Profile README

on:
  schedule:
    # Run twice a week: Monday and Thursday at 2 AM UTC
    - cron: "0 2 * * 1,4"
  workflow_dispatch: # Allow manual triggers
  push:
    branches:
      - main
    paths:
      - "scripts/**"
      - ".github/workflows/update-readme.yml"

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Get GitHub User ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          # Get the user ID for the repository owner
          USER_ID=$(gh api "users/${REPO_OWNER}" --jq '.id')
          echo "github_user_id=${USER_ID}" >> "${GITHUB_OUTPUT}"
          echo "Found GitHub user ID: ${USER_ID} for ${REPO_OWNER}"

      - name: Checkout create-task-action
        uses: actions/checkout@v4
        with:
          repository: coder/create-task-action
          ref: main
          path: ./.github/actions/create-task-action

      - name: Create Coder Task to Generate README
        id: create-task
        uses: ./.github/actions/create-task-action
        with:
          coder-url: ${{ secrets.CODER_URL }}
          coder-token: ${{ secrets.CODER_SESSION_TOKEN }}
          coder-organization: "default"
          coder-template-name: "cat-readme-task"
          coder-task-name-prefix: "readme-gen"
          coder-task-prompt: |
            Generate an impressive GitHub profile README for DevelopmentCats/DevelopmentCats.
            
            Process:
            1. cd ~/projects/DevelopmentCats
            2. Run: python3 scripts/generate_readme.py (fetches GitHub data â†’ data/github_stats.json)
            3. Read data/github_stats.json - it has:
               - languages.all_detected: ALL languages I use (show them all!)
               - languages.top_8: Most frequently used
               - coder_stats: Coder Registry contributions
               - recent_activity: Recent work
            4. Read scripts/ai_guidelines.md for styling rules
            5. Create README.md following these rules:
               
               STYLING (follow these):
               âœ… Center headers and main content with HTML
               âœ… Use proper alignment for badges and stats
               âœ… Professional spacing and visual hierarchy
               âœ… Clean, modern design
               
               CONTENT (your creative choice):
               âœ… Show ALL languages from data (languages.all_detected)
               âœ… Highlight Coder Registry work prominently
               âœ… Include GitHub stats visualizations
               âœ… Choose which sections to include
               âœ… Decide on layout and grouping
               âŒ Don't repeat bio/followers (GitHub shows that)
               
            6. Commit: git add README.md data/ && git commit -m "ðŸ¤– Auto-update README" && git push
            
            Make it impressive - show all skills while keeping it clean!
          github-user-id: ${{ steps.get-user-id.outputs.github_user_id }}
          github-token: ${{ github.token }}
          # Use run number to create unique task names (readme-gen-123, readme-gen-124, etc.)
          github-issue-url: ${{ github.server_url }}/${{ github.repository }}/issues/${{ github.run_number }}
          comment-on-issue: false

      - name: Output Task Info
        env:
          TASK_CREATED: ${{ steps.create-task.outputs.task-created }}
          TASK_NAME: ${{ steps.create-task.outputs.task-name }}
          TASK_URL: ${{ steps.create-task.outputs.task-url }}
        run: |
          {
            echo "## Coder Task Created"
            echo ""
            echo "**Status:** ${{ steps.create-task.outputs.task-created && 'New task created' || 'Existing task updated' }}"
            echo "**Task Name:** ${TASK_NAME}"
            echo "**Task URL:** ${TASK_URL}"
            echo ""
            echo "Claude Code is now generating your README! Check the task in your Coder deployment."
          } >> "${GITHUB_STEP_SUMMARY}"
